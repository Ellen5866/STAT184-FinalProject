
---
title: "Final Project Preliminary EDA"
author: "Ellen Liu"
date: "12-13-2020"
output: html_notebook
---

# Guiding Question: How gun-related violence affect the United States?
  As the US is one of the few countries in which the right to bear arms is constitutionally protected. A consequence of this is that the level of gun violence is very high compared to other countries. For instance, America has six times as many firearm homicides as Canada, and nearly 16 times as many as Germany. 
  
  Based on Wikipedia, Gun violence in the US results in tens of thousands of deaths and injuries annually. In 2013, there were 73,505 nonfatal firearm injuries which included 11,208 homicides, 21,175 suicides, 505 deaths due to accidental or negligent discharge of a firearm, and 281 deaths due to firearms use with "undetermined intent". 
  
  For this project, I have performed a deep exploration on this dataset of gun violence incidents reported in US by, Gun Violence Archive (GVA), a non-profit corporation formed in 2013 to provide free online public access to information about gun-related violence in the United States.
  
  I expect this analysis help us have a more comprehensive understanding about the gun violence in U.S. and take gun control more seriously.

## Data sources

### Primary data source: gun-violence-data_01-2013_03-2018.csv  (73.1 MB)
  I find the dataset from Kaggle website, it is a csv file called Gun Violence Data which contains data for all recorded gun violence incidents in the US between January 2013 and March 2018, 
[link](https://www.kaggle.com/jameslko/gun-violence-data)

  The data was downloaded from gunviolencearchive.org. Gun Violence Archive (GVA) is a not for profit corporation formed in 2013. GVA will collect and check for accuracy, comprehensive information about gun-related violence in the U.S. and then post and disseminate it online.

  They collected through 2013 to 2018 since all data is in this time range. And the reason they collected the data is to provide free online public access to accurate information about gun-related violence in the United States, and provide large and easily-accessible amounts of detailed data on gun violence.

```{r}
library(dplyr)
library(tidyverse)
#import primary data source
Gun_violence <- read.csv("/Users/ellenus/Desktop/5th\ Semester/Stat\ 184/Final\ Project/gun-violence-data_01-2013_03-2018.csv", header = TRUE)
# Inspect data, show first 10 rows of the data
head(Gun_violence, 10)
```

  Each case in the dataset represents a gun-related incident occurred during January 2013 and March 2018 with the information of where, when, why each incident happened and background of people involved. And there are total of 239677 cases available.

```{r}
# total case number
nrow(Gun_violence)
```

  I have delete several variables(some URLs, latitude, longitude and name) from the original file before importing, which I think are not really useful. And the rest of 22 variables will somehow used in my project and following variables are mainly used: date, state, n-killed,n-injured,age, gender
```{r}
#number of variables
ncol(Gun_violence)
```

### Inspecting data 

  As this project will relate to states and population in each state, I choose the ZipGeography dataset from DataComputing package which includes the population for 53 states.
```{r}
# load package
library(DataComputing)
# inspect data
help( ZipGeography)
str(ZipGeography)
head(ZipGeography, 10)
ZipGeography
```

  For this dataset, each case represents Information about the location, area, and housing units in each ZIP code area.
It contains 42741 cases and 13 variables. And I will mainly use the State, Population, City for this project. And to better compute my analysis, i modified the dataset to only contain
        
```{r}
city_ZipGeography<-
      ZipGeography %>%
      group_by(State,CityName) %>%
      summarise(count= sum(Population,na.rm = TRUE)) %>%
      rename(population = count)
       
State_ZipGeography<-
      ZipGeography %>%
      group_by(State) %>%
      summarise(count= sum(Population,na.rm = TRUE)) %>%
      rename(population = count)


city_ZipGeography
State_ZipGeography

```

## Explore intuition related to the research question

### Date: Comparing number of incidents by year, quarter and month
```{r}
str(Gun_violence)
```

```{r}
library(tidyr)
library( lubridate )
# reform the date
Gun_violence_new <-
 Gun_violence %>%
   mutate(date = mdy(date)) %>% # make the date variable tidier
   mutate(year = lubridate::year(date),month = lubridate::month(date),day = lubridate::day(date)) # split the date variable to three different variable: year, month, date
Gun_violence_new
str(Gun_violence_new)
```


```{r}
yearly <- 
  Gun_violence_new %>%
  filter(year!= 2013, year != 2018)  %>%
  group_by(year) %>%
  summarise(yearly= n()) %>%
  mutate(year_average = sum(yearly)/4)

yearly

```

```{r}
#plot yearly graph with average line
ggplot(yearly) + 
  geom_col(aes(x = year, y = yearly), size = 1, color = "darkblue", fill = "grey") +
  geom_line(aes(x = year, y = year_average), size = 1.5, color="red", group = 1) + 
  scale_y_continuous(sec.axis = sec_axis(~./3, name = "year_average"))+geom_text(aes(x = year, y = yearly, label = yearly), vjust = -0.2)+theme_linedraw() 
```
```{r}
library(ggplot2)
#Get quarter as new variable
Gun_violence_new$quarter <- quarter(Gun_violence_new$date)

quarterly <- 
  Gun_violence_new %>% 
  filter(year!=2013) %>% 
  select(year, quarter) %>% 
  group_by(year) %>% 
  count(quarter) %>%
        ggplot(aes(x=as.factor(quarter), y=n)) + geom_bar(stat='identity', fill = "violet") +
        scale_y_continuous(labels=comma) + facet_grid(.~year) + labs(x='Quarter', y='Number of incidents')+geom_text(aes(label = n), vjust = 1.5)+theme_linedraw() +facet_wrap(.~year,ncol=2)


quarterly
```
```{r}
#compare quarter 1 for each year
first_quarter <- 
  Gun_violence_new %>% 
  filter(year!=2013 & quarter==1) %>% 
  select(year, quarter) %>%
        group_by(year) %>% 
        count(quarter) %>%
        ggplot(aes(x=as.factor(year), y=n)) + geom_bar(stat='identity',fill = "blue") +
        scale_y_continuous(labels=comma) + labs(x='Incidents in Q1 of each year', y='Number of incidents')+geom_text(aes(label = n), vjust = -0.2)+theme_linedraw() 

first_quarter
```



```{r}
library(scales)
#plot monthly graph with for each year
monthly1<-
Gun_violence_new %>%
  filter(year!= 2013)  %>%
  group_by(year,month) %>%
  summarise(monthly= n()) 

monthly2<-
Gun_violence_new %>%
  filter(year!= 2013, year != 2018)  %>%
  group_by(month) %>%
  summarise(months= n())  %>%
  mutate(month_average = months/4)

monthly<-
  monthly1 %>%
left_join(monthly2, by = c("month"= "month")) 
  
monthly
```

```{r}
monthly%>%
ggplot(aes(x=month, y=monthly)) + geom_bar(stat='identity')  + facet_wrap(.~year,ncol=3) + labs(x='monthly', y='Number of incidents')+scale_x_continuous(breaks = pretty_breaks())+theme_linedraw() +geom_line(aes(x = month, y = month_average), size = 1, color="red", group = 1) 

```


## Location: Comparing number of incidents by State and city.

```{r}
# the top 10 states with the most gun-related violence during the period
top10State <- 
  Gun_violence %>%
  group_by(state) %>%
  summarise(case_count= n()) %>%
   arrange(desc(case_count)) %>%
   head(10)
top10State
```

```{r}
ggplot(data=top10State, aes(x=state, y=case_count)) +
  geom_bar(stat="identity")

```

```{r}
#Incidents of each State in descending order
topState <- 
  Gun_violence %>%
  group_by(state) %>%
  summarise(case_count= n()) %>%
   arrange(desc(case_count))

#Incidents relative to the State population size
crimedensity<-
  topState %>%
left_join(State_ZipGeography, by = c("state"= "State")) %>%
  mutate(per_million=case_count/(population/1000000))


crimedensity
```

```{r}
crimedensity %>%
  ggplot(aes(y=reorder(state, per_million), x=per_million, fill=per_million, text=state,width=.7))+geom_bar(stat='identity')+theme(legend.position="none")+labs(x='Incidents per million people', y='State')+theme_linedraw()
```
```{r}
#download package
install.packages("usmap")
```

```{r}
#load package
library(usmap)

#Graph gun-related incidents in the U.S map
plot_usmap(data = crimedensity,values="per_million",color="blue") + 
  labs(title = "gun-related incidents in the U.S",
       subtitle = "Source: GVA, 2013-2018") + scale_fill_continuous(low="white",high="darkred",name="incident_density",label=scales::comma)
  theme(legend.position = "right")
```
```{r}
#add new variable: victims
Gun_violence_new$victims <- Gun_violence_new$n_killed + Gun_violence_new$n_injured

Victims1 <- 
  Gun_violence_new %>% 
  group_by(state) %>%
  summarize(sumVic=sum(victims), sumInj=sum(n_injured), sumDeath=sum(n_killed), PercDeath=round(sumDeath/sumVic,2), sumIncidents=n(), vicPerInc=round(sumVic/sumIncidents,2))

victims<-
  Victims1 %>%
left_join(State_ZipGeography, by = c("state"= "State"))

head(victims)
```

```{r}
victims %>% 
ggplot(aes(x=population, y=vicPerInc)) + geom_point(stat='identity',color="darkred") +
        labs(x='population', y='Victims per incidents') +geom_smooth(method=lm)+theme_linedraw()
```

## Type: Comparing number of incidents by characteristics.

```{r}
# use regular expression replacing "||" with "|" as both separators are used
Gun_violence_new$incident_characteristics <- gsub("\\|\\|", "|", Gun_violence_new$incident_characteristics)
```

```{r}
#download package
install.packages("splitstackshape")
install.packages("gridExtra")
library(splitstackshape)
library(gridExtra )
```

```{r}
#split the column and store all characteristics as separate observations in a new dataframe
Incident_type <- 
  splitstackshape::cSplit(Gun_violence_new %>% 
                            select(incident_id, state, city_or_county, incident_characteristics), 'incident_characteristics', sep =  '|', direction="long")

head(Incident_type,8)
```
```{r}
Incident_type%>% 
  count(incident_characteristics) %>% 
  top_n(30, wt=n) %>%
        ggplot(aes(x=reorder(incident_characteristics, n), y=n)) +
        geom_bar(stat='identity', fill='orange')  +coord_flip() + labs(x='Incident Category', y='number of incidents')+theme_linedraw()
```

```{r}
overall_categories <- c("Shot - Wounded/Injured", "Shot - Dead (murder, accidental, suicide)", "Non-Shooting Incident", "Shots Fired - No Injuries")

coloursShot <- c("Shot - Wounded/Injured"="red", "Shot - Dead (murder, accidental, suicide)"="darkred", "Non-Shooting Incident"="green", "Shots Fired - No Injuries"="yellow")

uscategories <- function(fixedX=0.5){
   Incident_type %>% 
    filter(incident_characteristics %in% overall_categories) %>%
   count(incident_characteristics) %>%
   ggplot(aes(x=reorder(incident_characteristics, n), y=n/sum(n), fill=factor(incident_characteristics))) +
   geom_bar(stat='identity', width = 0.5) + scale_fill_manual(values = coloursShot) +
   theme(legend.position="none") + coord_flip(ylim = c(0, fixedX)) + labs(x="", y='US overall') +
   scale_y_continuous(labels=percent)
}

#
citycategories <- function(cityName){
   Incident_type %>% 
    filter(city_or_county==cityName & incident_characteristics %in% overall_categories) %>%
   count(incident_characteristics) %>%
   ggplot(aes(x=reorder(incident_characteristics, n), y=n/sum(n), fill=factor(incident_characteristics))) +
   geom_bar(stat='identity', width = 0.5) + scale_fill_manual(values = coloursShot) +
   theme(legend.position="none") + coord_flip(ylim = c(0, 0.8)) + labs(x="", y=cityName) +
   scale_y_continuous(labels=percent)
}

usOverall_categories <- uscategories(0.8)
baltimore_categories <- citycategories('Baltimore')
washington_categories <- citycategories('Washington')
chicago_categories <- citycategories('Chicago')
orlando_categories <- citycategories('Orlando')

grid.arrange(usOverall_categories, baltimore_categories, washington_categories, chicago_categories,orlando_categories, ncol=1)
```
Base on the graph above, we can see that except Washington, 

in Baltimore the percentage of incidents with people wounded is high (20% higher than US average). In addition, there are very few incidents with shots fired and people not injured.
In Washington DC, despite having a high average of incidents per 100,000 incidents, incidents are on average less severe than the US average. Relatively, there are more Non-Shooting incidents, and less incidents with deadly victims.
In Chicago, the percentage of incidents with wounded people is very high. On the other hand, the percentage of incidents with deadly victims is a bit lower than the US average.

## Conclusion & Summary

Based on the data wrangling and graphs, I can easily tell that the violence cases are increasing pretty rapidly with the time past. Besides the top 10 states with most gun-related violence are all big states with large population. With the further research, I want to look deeply about the month the age group and specif area that most likely the gum-relate violence happen.
